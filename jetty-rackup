#!/usr/bin/env jruby
# -*- ruby -*-

require 'java'
require 'rubygems'
require 'warbler' # jruby-rack-0.9.5.jar

rb_root = File.dirname(__FILE__)
app_root = File.dirname(__FILE__)+'/../'

Dir[app_root+"./*.jar"].each { |jar| require jar }
require 'rack'

Dir["/D/vd-home/opt/jruby-1.3.0/lib/ruby/gems/1.8/gems/jetty-rails-0.8.1/jetty-libs/*.jar"].each { |jar| require jar }
require '/D/vd-home/opt/jruby-1.3.0/lib/ruby/gems/1.8/gems/warbler-0.9.14/lib/jruby-rack-0.9.5.jar'
Dir[app_root+"./Java/jsdk/*.jar"].each { |jar| require jar }

include_class 'javax.servlet.http.HttpServlet'
include_class 'org.mortbay.jetty.Server'
include_class 'org.mortbay.jetty.servlet.Context'
include_class 'org.mortbay.jetty.servlet.ServletHolder'
include_class 'org.jruby.rack.servlet.ServletRackContext'
include_class 'org.mortbay.jetty.handler.ResourceHandler'
include_class 'org.mortbay.jetty.handler.DefaultHandler'
include_class 'org.mortbay.jetty.handler.HandlerList'
include_class 'org.mortbay.jetty.handler.ResourceHandler'
include_class 'org.mortbay.jetty.handler.ContextHandlerCollection'
include_class 'org.mortbay.jetty.servlet.DefaultServlet'

config = ARGV[0] || "config.ru"
if !File.exist? config
  abort "configuration #{config} not found"
end

server = org.mortbay.jetty.Server.new 4566

context = org.mortbay.jetty.servlet.Context.new(nil, "/", org.mortbay.jetty.servlet.Context::NO_SESSIONS)
context.add_filter("org.jruby.rack.RackFilter", "/*", org.mortbay.jetty.Handler::DEFAULT)
context.set_resource_base(File.dirname(__FILE__))
context.add_event_listener(org.jruby.rack.RackServletContextListener.new)

rackup = File.read(config)
  "
      run lambda { |env| [200, {}, '<h1>Hello From JRuby
Rack!</h1>'+Time.now.to_s+'<br> env:'+env.inspect]  }
    "


context.set_init_params(java.util.HashMap.new(
    #'rails.root'=> '.', 'public.root' => 'public',
    'org.mortbay.jetty.servlet.Default.relativeResourceBase' => '/public',
    'rackup' => rackup,
    'jruby.max.runtimes' => '1'))
 context.add_servlet(org.mortbay.jetty.servlet.ServletHolder.new(
     org.mortbay.jetty.servlet.DefaultServlet.new), "/")

 server.set_handler(context)
 server.start

